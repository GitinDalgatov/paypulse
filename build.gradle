plugins {
    id 'java'
    id 'org.springframework.boot' version '3.2.4' apply false
    id 'io.spring.dependency-management' version '1.1.4' apply false
    id 'org.liquibase.gradle' version '2.2.1' apply false
}

allprojects {
    group = 'com.paypulse'
    version = '1.0.0'
    
    repositories {
        mavenCentral()
        maven { url 'https://repo.spring.io/milestone' }
        maven { url 'https://repo.spring.io/snapshot' }
    }
}

subprojects {
    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'
    
    java {
        sourceCompatibility = JavaVersion.VERSION_21
        targetCompatibility = JavaVersion.VERSION_21
    }
    
    configurations {
        compileOnly {
            extendsFrom annotationProcessor
        }
    }
    
    dependencyManagement {
        imports {
            mavenBom "org.springframework.cloud:spring-cloud-dependencies:2023.0.0"
        }
    }
    
    dependencies {
        implementation 'org.projectlombok:lombok'
        annotationProcessor 'org.projectlombok:lombok'
        testImplementation 'org.springframework.boot:spring-boot-starter-test'
    }
    
    tasks.named('test') {
        useJUnitPlatform()
    }
    
}

task cleanAll(type: Delete) {
    delete rootProject.buildDir
    delete subprojects*.buildDir
}

task buildAll {
    dependsOn subprojects*.build
}

task testAll {
    dependsOn subprojects*.test
}

task bootRunAll {
    dependsOn subprojects*.bootRun
}

task buildServices {
    dependsOn ':paypulse-common:build'
    dependsOn ':auth-service:build'
    dependsOn ':wallet-service:build'
    dependsOn ':transaction-service:build'
    dependsOn ':notification-service:build'
    dependsOn ':analytics-service:build'
    dependsOn ':api-gateway:build'
}

task cleanServices {
    dependsOn ':paypulse-common:clean'
    dependsOn ':auth-service:clean'
    dependsOn ':wallet-service:clean'
    dependsOn ':transaction-service:clean'
    dependsOn ':notification-service:clean'
    dependsOn ':analytics-service:clean'
    dependsOn ':api-gateway:clean'
}

task dockerBuildAll {
    dependsOn buildServices
    doLast {
        println "Ğ’ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ñ‹. Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ docker-compose up -d"
    }
}

task dockerUp {
    doLast {
        exec {
            commandLine 'docker-compose', 'up', '-d'
        }
    }
}

task dockerDown {
    doLast {
        exec {
            commandLine 'docker-compose', 'down'
        }
    }
}

task dockerRestart {
    dependsOn dockerDown
    dependsOn dockerUp
}

task dockerLogs {
    doLast {
        exec {
            commandLine 'docker-compose', 'logs', '-f'
        }
    }
}

task dockerStatus {
    doLast {
        exec {
            commandLine 'docker-compose', 'ps'
        }
    }
}

task liquibaseUpdateAll {
    dependsOn ':auth-service:update'
    dependsOn ':wallet-service:update'
    dependsOn ':transaction-service:update'
    dependsOn ':notification-service:update'
    dependsOn ':analytics-service:update'
    doLast {
        println "Ğ’ÑĞµ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ Ñ‡ĞµÑ€ĞµĞ· Liquibase"
    }
}

task liquibaseStatusAll {
    dependsOn ':auth-service:status'
    dependsOn ':wallet-service:status'
    dependsOn ':transaction-service:status'
    dependsOn ':notification-service:status'
    dependsOn ':analytics-service:status'
    doLast {
        println "Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ²ÑĞµÑ… Ğ±Ğ°Ğ· Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞµĞ½"
    }
}

task devBuild {
    dependsOn cleanServices
    dependsOn buildServices
    doLast {
        println "ĞŸÑ€Ğ¾ĞµĞºÑ‚ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½ Ğ¸ Ğ¿ĞµÑ€ĞµÑĞ¾Ğ±Ñ€Ğ°Ğ½ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸"
    }
}

task quickBuild {
    dependsOn buildServices
    doLast {
        println "Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°"
    }
}

task healthCheck {
    doLast {
        println "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°..."
        exec {
            commandLine 'docker-compose', 'ps'
        }
    }
}

task logsAll {
    doLast {
        exec {
            commandLine 'docker-compose', 'logs', '--tail=100'
        }
    }
}

task projectHelp {
    group = 'help'
    description = 'ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¿Ñ€Ğ°Ğ²ĞºÑƒ Ğ¿Ğ¾ Ğ²ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°Ğ¼'
    
    doLast {
        println """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           PAYPULSE GRADLE TASKS                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                              â•‘
â•‘  ğŸ—ï¸  ĞĞ¡ĞĞĞ’ĞĞ«Ğ• Ğ—ĞĞ”ĞĞ§Ğ˜:                                                       â•‘
â•‘     buildServices     - Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹                                  â•‘
â•‘     cleanServices     - ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹                                â•‘
â•‘     testAll           - Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹                                 â•‘
â•‘     bootRunAll        - Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹                               â•‘
â•‘                                                                              â•‘
â•‘  ğŸ³  DOCKER Ğ—ĞĞ”ĞĞ§Ğ˜:                                                          â•‘
â•‘     dockerBuildAll    - Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸ Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ»Ñ Docker                    â•‘
â•‘     dockerUp          - Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Docker Compose                            â•‘
â•‘     dockerDown        - ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Docker Compose                           â•‘
â•‘     dockerRestart     - ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Docker Compose                        â•‘
â•‘     dockerStatus      - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²                         â•‘
â•‘     dockerLogs        - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²                           â•‘
â•‘                                                                              â•‘
â•‘  ğŸ—„ï¸  LIQUIBASE Ğ—ĞĞ”ĞĞ§Ğ˜:                                                       â•‘
â•‘     liquibaseUpdateAll - ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…                           â•‘
â•‘     liquibaseStatusAll - ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ²ÑĞµÑ… Ğ‘Ğ”                           â•‘
â•‘                                                                              â•‘
â•‘  ğŸ› ï¸  Ğ ĞĞ—Ğ ĞĞ‘ĞĞ¢ĞšĞ:                                                             â•‘
â•‘     devBuild          - ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¿ĞµÑ€ĞµÑĞ±Ğ¾Ñ€ĞºĞ° Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸                    â•‘
â•‘     quickBuild        - Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ°                                      â•‘
â•‘                                                                              â•‘
â•‘  ğŸ“Š  ĞœĞĞĞ˜Ğ¢ĞĞ Ğ˜ĞĞ“:                                                             â•‘
â•‘     healthCheck       - ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°                          â•‘
â•‘     logsAll           - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²                         â•‘
â•‘                                                                              â•‘
â•‘  ğŸ“‹  ĞŸĞĞ›Ğ•Ğ—ĞĞ«Ğ• ĞšĞĞœĞĞĞ”Ğ«:                                                      â•‘
â•‘     ./gradlew tasks   - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸                                â•‘
â•‘     ./gradlew projectHelp - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ñƒ ÑĞ¿Ñ€Ğ°Ğ²ĞºÑƒ                            â•‘
â•‘     ./gradlew :service:build - Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ                    â•‘
â•‘                                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        """
    }
}
